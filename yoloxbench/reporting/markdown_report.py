"""
Create a rich Markdown report (tables + plots) from YOLOxBench runs.

Usage
-----
$ yox report <csv> [<run1> <run2> ...]

Outputs:
  cmp_runs/<csv_basename>_report/
      report.md
      bar_metrics.png
      pr_curves/
      confusion_matrices/
"""
from __future__ import annotations
from pathlib import Path
from datetime import datetime
import shutil
import pandas as pd
import matplotlib.pyplot as plt

# Define which metrics to include in the report
METRICS = [
    "metrics/mAP50",
    "metrics/mAP50-95",
    "metrics/precision",
    "metrics/recall",
]

# Markdown template
_MD_HEADER = """# ðŸ“‹ YOLOxBench Comparison Report

*Generated: {date}*

**Compared Runs:** {runs}

---

## ðŸ§® Metrics Summary

| Run | {cols} |
|-----|{dashes}|
{summary_rows}

---

## ðŸ† Leaderboard Bars

![Metrics Bar]({bar_png})

---

## ðŸ“ˆ Precisionâ€‘Recall Curves
{pr_section}

---

## ðŸ”€ Confusion Matrices
{cm_section}

---

> *Report autoâ€‘generated by **YOLOxBench**.*
"""

def _ensure_dir(p: Path) -> Path:
    "Ensure directory exists and return it."
    p.mkdir(parents=True, exist_ok=True)
    return p


def _plot_bar(df: pd.DataFrame, metric: str, out: Path):
    "Plot a bar chart for the given metric and save it."
    plt.figure(figsize=(8, 4))
    df.plot.bar(x="run", y=metric, legend=False, ax=plt.gca())
    plt.ylabel(metric)
    plt.tight_layout()
    plt.savefig(out)
    plt.close()


def make_markdown(csv_path: Path, runs: list[str] | None = None) -> Path:
    """
    Generate a Markdown report comparing the given runs.

    Parameters
    ----------
    csv_path : Path
        Path to CSV file with a 'run' column and metric columns.
    runs : list[str] | None
        Optional list of run names in the order to report. If omitted,
        runs are inferred from the CSV's 'run' column.
    """
    csv_path = Path(csv_path)
    df = pd.read_csv(csv_path)

    # Infer runs if not provided
    if runs is None:
        if "run" not in df.columns:
            raise ValueError("CSV must contain a 'run' column when runs not passed")
        runs = df["run"].tolist()

    # Setup output folder based on CSV stem
    report_dir = _ensure_dir(csv_path.parent / f"{csv_path.stem}_report")

    # 1) Leaderboard bar for the first metric
    bar_png = report_dir / "bar_metrics.png"
    primary = METRICS[0]
    _plot_bar(df, primary, bar_png)

    # 2) Copy PR curves and confusion matrices
    pr_dir = _ensure_dir(report_dir / "pr_curves")
    cm_dir = _ensure_dir(report_dir / "confusion_matrices")
    pr_section, cm_section = [], []
    for run in runs:
        src_run = Path(csv_path.parent.parent) / "detect" / run
        # PR curve
        src_pr = src_run / "PR_curve.png"
        if src_pr.exists():
            dst_pr = pr_dir / f"{run}_PR.png"
            shutil.copy(src_pr, dst_pr)
            pr_section.append(f"![{run} PR]({dst_pr.relative_to(report_dir)})")
        # Confusion matrix
        src_cm = src_run / "confusion_matrix.png"
        if src_cm.exists():
            dst_cm = cm_dir / f"{run}_CM.png"
            shutil.copy(src_cm, dst_cm)
            cm_section.append(f"![{run} CM]({dst_cm.relative_to(report_dir)})")

    pr_text = "\n".join(pr_section) or "_No PR curves found._"
    cm_text = "\n".join(cm_section) or "_No confusion matrices found._"

    # 3) Metrics summary table rows
    cols_header = " | ".join([m.split("/")[-1] for m in METRICS])
    dashes = "|" + "---|" * (len(METRICS) + 1)
    summary_rows = []
    for _, row in df.iterrows():
        vals = []
        for m in METRICS:
            v = row.get(m)
            vals.append(f"{v:.3f}" if pd.notna(v) else "â€”")
        summary_rows.append(f"| {row['run']} | {' | '.join(vals)} |")
    summary_text = "\n".join(summary_rows)

    # 4) Render Markdown
    md = _MD_HEADER.format(
        date=datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
        runs=", ".join(runs),
        cols=cols_header,
        dashes=dashes,
        summary_rows=summary_text,
        bar_png=bar_png.name,
        pr_section=pr_text,
        cm_section=cm_text,
    )

    # Write to disk
    report_md = report_dir / "report.md"
    report_md.write_text(md, encoding="utf-8")
    return report_md